---
title: "Exam2022"
author: "tfd199, lhb642, tgx333"
date: "6/11/2022"
output: pdf_document
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(readr)
library(RSQLite)
library(tidyverse)
library(tidymodels) 
library(furrr) 
library(glmnet)
library(broom)
library(timetk)
library(scales)
library(lubridate)
library(scales)
library(frenchdata)
library(caret)
library(ggplot2)
library(ggpubr)
library(kableExtra)
library(mltools)
library(data.table)
library(vtable)
library(keras)
library(quadprog)
library(rmgarch)
library(xts)
```


### 1.
**Use the data until December 31, 2015 to estimate the parameters of the Fama French 3-factor model.**
We load in the csv file. First we filter the data so that we have until (and including) December 31st 2015. Next, we loop through each permno to perform the regression to estimate the parameters of the Fama-French 3 factor model. 
```{r}
#Loading in the CSV file
data <- read_csv("data/data_exam2022.csv") %>%
  filter(month < "2016-01-01") %>% drop_na()

#Estimation:
#Creating matrix to store coefficient values
coefficients <- matrix(NA,
                             nrow = nrow(unique(data['permno'])),
                             ncol = 5) 

colnames(coefficients) = c("Permno","Alpha","beta_M","beta_smb","beta_hml")

models <- matrix(NA,
                             nrow = nrow(unique(data['permno'])),
                             ncol = 5) 

colnames(models) = c("Permno","Alpha","beta_M","beta_smb","beta_hml")

for (i in 1:nrow(unique(data['permno']))) { #Looping through permnos
  
  
  t =  unique(data['permno'])[i,]
  coefficients[i,2:5] <- lm(ret_excess ~ mkt_excess + smb + hml, 
     data = data %>% filter(permno == t[[1]] )) %>% coefficients()
  
  coefficients[i,1] <- t[[1]]
  
}

#Creating table to portray results
coefficients %>% kbl(caption = "Table 1: Summary of Fama-French 3 Factor model regression coefficients",digits = 4) %>%
  kable_classic(full_width = F, html_font = "Cambria")

```
**Give a brief interpretation of the values.**
The above table shows the estimated alpha along with variable coefficients for all variables in the 3 factor model. Alpha can be interpreted as the intercept, i.e. the return in excess of the expected return, conditional on the variables included in the model. The beta values are the regression coefficients for the included variables and shows how much of the expected excess return of asset i that is explained by the market excess return, the small minus big and high minus low factor returns respectively. 

**Derive the model-implied expected gross excess return and the model-implied variance covariance matrix.**
We use the estimated model for each stock to derive a full series of model-implied expected returns. When that is done, we take the mean of the series for each asset to arrive at a final model-implied expected gross excess return. For the variance covariance matrix, we simply use the cov() function on the return matrix used to find $\hat{\mu}^{FF}$.
```{r}

ret_matrix <- matrix(NA,
                             nrow = nrow(data %>% filter(permno=='10026')),
                             ncol = 8) 

colnames(ret_matrix) = c("10026","10032","10044","10104","10200","10232","10252","10397")

for (m in 1:nrow(unique(data['permno']))) {
  
   l =  unique(data['permno'])[m,]
 ret_matrix[,m] <-  predict(lm(ret_excess ~ mkt_excess + smb + hml, 
     data = data %>% filter(permno == l[[1]] )), newdata = data %>% filter(permno==l[[1]]) %>% select(mkt_excess,smb,hml))
 
 
}
 
# using the returns matrix, we can compute the covariance matrix and sample mean
sigma <- cov(ret_matrix)
mu <- colMeans(ret_matrix)


t(mu) %>% kbl(caption = "Table 2: Model-implied expected gross excess returns",digits = 4) %>%
  kable_classic(full_width = F, html_font = "Cambria")

t(sigma) %>% kbl(caption = "Table 3: Model-implied variance-covariance matrix",digits = 4) %>%
  kable_classic(full_width = F, html_font = "Cambria")
```

*What determines the correlation of the returns?*
In our model, all predictors (market excess, smb and hml returns) have the same value throughout the series across all permnos. Therefore, the only thing that determines the estimated excess returns, and thus the only thing that makes the estimated returns differ, are the weights assigned to each variable, i.e. the coefficients. Adding to this, the betas themselves are determined using OLS, where the aim is to fit the regression by minimizing the squared errors, i.e. the sum of the square differences between the observed and predicted values. Therefore, the beta value of a given firm depends on the performance of the firm's stock relative to the performance of all other stocks.