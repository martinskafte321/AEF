mom_portfolios_summary
mom_portfolios_summary %>%
as.numeric(lm(weighted_mom ~ 1 + mkt_excess))
mom_portfolios_summary
lm(mom_portfolios_summary$weighted_mom ~ 1 + mom_portfolios_summary$mkt_excess)
vw_momentum_portfolios %>%
left_join(factors_ff_monthly, by = "month") %>%
group_by(portfolio) %>%
summarise(
alpha = as.numeric(lm(weighted_mom ~ 1 + mkt_excess)$coefficients[1]),
beta = as.numeric(lm(weighted_mom ~ 1 + mkt_excess)$coefficients[2]),
)
vw_momentum_portfolios %>%
left_join(factors_ff_monthly, by = "month") %>%
group_by(portfolio) %>%
summarise(
alpha = as.numeric(lm(weighted_mom ~ 1 + mkt_excess))
vw_momentum_portfolios
momentum_portfolios
vw_momentum_portfolios = momentum_portfolios %>%
group_by(portfolio, month) %>%
summarize(weighted_mom = weighted.mean(momentum, mktcap), .groups = "drop")
vw_momentum_portfolios
vw_momentum_portfolios[[1000]]
vw_momentum_portfolios[1000]
vw_momentum_portfolios[1000,]
vw_momentum_portfolios[6000,]
vw_momentum_portfolios[7000,]
vw_momentum_portfolios[8000,]
vw_momentum_portfolios[7180,]
vw_momentum_portfolios %>%
left_join(factors_ff_monthly, by = "month") %>%
group_by(portfolio) %>%
summarise(
alpha = as.numeric(lm(weighted_mom ~ 1 + mkt_excess))
vw_momentum_portfolios %>%
vw_momentum_portfolios = momentum_portfolios %>%
group_by(portfolio, month) %>%
summarize(weighted_mom = weighted.mean(momentum, mktcap), .groups = "drop")
vw_momentum_portfolios
vw_momentum_portfolios %>%
left_join(factors_ff_monthly, by = "month") %>%
group_by(portfolio) %>%
summarise(
alpha = as.numeric(lm(weighted_mom ~ 1 + mkt_excess))
vw_momentum_portfolios %>%
mom_portfolios_summary <- vw_momentum_portfolios %>%
left_join(factors_ff_monthly, by = "month") %>%
group_by(portfolio) %>%
summarise(
alpha = (weighted_mom ~ 1 + mkt_excess))
vw_momentum_portfolios %>%
left_join(factors_ff_monthly, by = "month") %>%
group_by(portfolio) %>%
summarise(
alpha = lm(weighted_mom ~ 1 + mkt_excess))
vw_momentum_portfolios %>%
left_join(factors_ff_monthly, by = "month") %>%
group_by(portfolio) %>%
summarise(
alpha = as.numeric(lm(weighted_mom ~ 1 + mkt_excess)))
beta_portfolios <- data_for_sorting %>%
group_by(month) %>%
mutate(
portfolio = assign_portfolio(
data = cur_data(),
var = momentum,
n_portfolios = 10
),
portfolio = as.factor(portfolio)
) %>%
group_by(portfolio, month) %>%
summarize(ret = weighted.mean(momentum, mktcap_lag), .groups = "drop")
beta_portfolios
beta_portfolios %>%
left_join(factors_ff_monthly, by = "month") %>%
group_by(portfolio) %>%
summarise(
alpha = as.numeric(lm(ret ~ 1 + mkt_excess)$coefficients[1]),
beta = as.numeric(lm(ret ~ 1 + mkt_excess)$coefficients[2]),
ret = mean(ret)
)
beta_portfolios %>%
filter(portfolio==5)
beta_portfolios %>%
left_join(factors_ff_monthly, by = "month") %>%
filter(portfolio==5)
beta_portfolios %>%
left_join(factors_ff_monthly, by = "month") %>%
filter(portfolio==5) %>%
group_by(portfolio)
beta_portfolios %>%
left_join(factors_ff_monthly, by = "month") %>%
filter(portfolio==5) %>%
group_by(portfolio) %>%
summarise(alpha = as.numeric(lm(ret ~ 1 + mkt_excess) ))
beta_portfolios %>%
filter(portfolio==5)
left_join(factors_ff_monthly, by = "month") %>%
#group_by(portfolio) %>%
summarise(
alpha = as.numeric(lm(ret ~ 1 + mkt_excess)$coefficients[1]),
beta = as.numeric(lm(ret ~ 1 + mkt_excess)$coefficients[2]),
ret = mean(ret)
)
beta_portfolios %>%
filter(portfolio==5)
left_join(factors_ff_monthly, by = "month") %>%
#group_by(portfolio) %>%
summarise(
alpha = as.numeric(lm(ret ~ 1 + mkt_excess)$coefficients[1]),
beta = as.numeric(lm(ret ~ 1 + mkt_excess)$coefficients[2]),
ret = mean(ret)
)
beta_portfolios %>%
filter(portfolio==5)
beta_portfolios %>%
filter(portfolio==5) %>%
left_join(factors_ff_monthly, by = "month") %>%
summarise(
alpha = as.numeric(lm(ret ~ 1 + mkt_excess)$coefficients[1]),
beta = as.numeric(lm(ret ~ 1 + mkt_excess)$coefficients[2]),
ret = mean(ret)
)
beta_portfolios %>%
filter(portfolio==6) %>%
left_join(factors_ff_monthly, by = "month") %>%
summarise(
alpha = as.numeric(lm(ret ~ 1 + mkt_excess)$coefficients[1]),
beta = as.numeric(lm(ret ~ 1 + mkt_excess)$coefficients[2]),
ret = mean(ret)
)
beta_portfolios
beta_portfolio <- data_for_sorts %>%
group_by(month) %>%
mutate(
portfolio = assign_portfolio(
data = cur_data(),
var = beta_lag,
n_portfolios = 10
),
portfolio = as.factor(portfolio)
) %>%
group_by(portfolio, month) %>%
summarize(ret = weighted.mean(ret_excess, mktcap_lag))
beta_portfolio %>%
left_join(factors_ff_monthly, by = "month") %>%
group_by(portfolio) %>%
summarise(
alpha = as.numeric(lm(ret ~ 1 + mkt_excess)$coefficients[1]),
beta = as.numeric(lm(ret ~ 1 + mkt_excess)$coefficients[2]),
ret = mean(ret)
)
beta_portfolio
data_for_sorting
data_for_sorting %>%
group_by(month) %>%
mutate(
portfolio = assign_portfolio(
data = cur_data(),
var = momentum,
n_portfolios = 10
),
portfolio = as.factor(portfolio)
) %>%
group_by(portfolio, month)
momentum_portfolios %>%
group_by(portfolio, month)
momentum_portfolios
momentum_portfolios %>%
group_by(portfolio, month) %>%
summarize(ret = weighted.mean(ret_excess, mktcap), .groups = "drop")
vw_momentum_portfolios = momentum_portfolios %>%
group_by(portfolio, month) %>%
summarize(ret = weighted.mean(ret_excess, mktcap), .groups = "drop")
vw_momentum_portfolios
vw_momentum_portfolios %>%
left_join(factors_ff_monthly, by = "month") %>%
group_by(portfolio) %>%
summarise(
alpha = as.numeric(lm(ret ~ 1 + mkt_excess)$coefficients[1]),
beta = as.numeric(lm(ret ~ 1 + mkt_excess)$coefficients[2]),
ret = mean(ret)
)
mom_portfolios_summary <- vw_momentum_portfolios %>%
left_join(factors_ff_monthly, by = "month") %>%
group_by(portfolio) %>%
summarise(
alpha = as.numeric(lm(ret ~ 1 + mkt_excess)$coefficients[1]),
beta = as.numeric(lm(ret ~ 1 + mkt_excess)$coefficients[2]),
ret = mean(ret)
)
mom_portfolios_summary
mom_portfolios_summary %>%
ggplot(aes(x = portfolio, y = alpha, fill = portfolio)) +
geom_bar(stat = "identity") +
labs(
title = "Alphas of momentum-sorted portfolios",
x = "Portfolio",
y = "CAPM alpha",
fill = "Portfolio"
) +
scale_y_continuous(labels = percent) +
theme(legend.position = "None")
vw_momentum_portfolios
vw_momentum_portfolios = momentum_portfolios %>%
group_by(portfolio, month) %>%
summarize(excess_ret = weighted.mean(ret_excess, mktcap), .groups = "drop")
mom_portfolios_summary <- vw_momentum_portfolios %>%
left_join(factors_ff_monthly, by = "month") %>%
group_by(portfolio) %>%
summarise(
alpha = as.numeric(lm(excess_ret ~ 1 + mkt_excess)$coefficients[1]),
beta = as.numeric(lm(excess_ret ~ 1 + mkt_excess)$coefficients[2]),
excess_ret = mean(excess_ret)
)
mom_portfolios_summary %>%
ggplot(aes(x = portfolio, y = alpha, fill = portfolio)) +
geom_bar(stat = "identity") +
labs(
title = "Alphas of momentum-sorted portfolios",
x = "Portfolio",
y = "CAPM alpha",
fill = "Portfolio"
) +
scale_y_continuous(labels = percent) +
theme(legend.position = "None")
mom_portfolios_summary
vw_momentum_portfolios %>%
left_join(factors_ff_monthly, by = "month") %>%
group_by(portfolio) %>%
summarise(
excess_ret = mean(excess_ret)
)
vw_momentum_portfolios %>%
left_join(factors_ff_monthly, by = "month") %>%
group_by(portfolio) %>%
summarise(
alpha = as.numeric(lm(excess_ret ~ 1 + mkt_excess)$coefficients[1]),
beta = as.numeric(lm(excess_ret ~ 1 + mkt_excess)$coefficients[2]),
excess_ret = mean(excess_ret)
)
mom_portfolios_summary %>% kbl()
mom_portfolios_summary
mom_portfolios_summary %>%
ggplot(aes(x = portfolio, y = alpha, fill = portfolio)) +
geom_bar(stat = "identity") +
labs(
title = "Alphas of momentum-sorted portfolios",
x = "Portfolio",
y = "CAPM alpha",
fill = "Portfolio"
) +
scale_y_continuous(labels = percent) +
theme(legend.position = "None")
df = vw_momentum_portfolios %>%
filter(portfolio==2) %>%
left_join(factors_ff_monthly, by = "month") %>%
group_by(portfolio)
df
?lm
lm(excess_ret ~ mkt_excess, data = df)
mom_portfolios_summary
df = vw_momentum_portfolios %>%
filter(portfolio==1) %>%
left_join(factors_ff_monthly, by = "month") %>%
group_by(portfolio)
lm(excess_ret ~ mkt_excess, data = df)
df
mom_portfolios_summary
mom_portfolios_summary %>%
ggplot(aes(x = portfolio, y = alpha, fill = portfolio)) +
geom_bar(stat = "identity") +
labs(
title = "Alphas of momentum-sorted portfolios",
x = "Portfolio",
y = "CAPM alpha",
fill = "Portfolio"
) +
scale_y_continuous(labels = percent) +
theme(legend.position = "None")
vw_momentum_portfolios
vw_momentum_portfolios %>%
pivot_wider(names_from = portfolio, values_from = excess_ret)
vw_momentum_portfolios %>%
pivot_wider(names_from = portfolio, values_from = excess_ret)
vw_momentum_portfolios
vw_momentum_portfolios %>%
pivot_wider(names_from = portfolio, values_from = excess_ret)
vw_momentum_portfolios %>%
pivot_wider(names_from = portfolio, values_from = excess_ret) %>%
mutate(high_low = vw_momentum_portfolios$"10"-vw_momentum_portfolios$"1")
vw_momentum_portfolios %>%
pivot_wider(names_from = portfolio, values_from = excess_ret) %>%
mutate(high_low = vw_momentum_portfolios[1])
vw_momentum_portfolios %>%
pivot_wider(names_from = portfolio, values_from = excess_ret)
vw_momentum_portfolios
momentum_portfolios
momentum_portfolios %>%
group_by(month) %>%
mutate(breakpoint = median(momentum),
portfolio = case_when(momentum <= breakpoint ~ "low",
momentum > breakpoint ~ "high"))
momentum_portfolios %>%
group_by(month) %>%
mutate(breakpoint = median(momentum),
portfolio = case_when(momentum <= breakpoint ~ "low",
momentum > breakpoint ~ "high")) %>%
group_by(month,portfolio) %>%
summarise(excess = weighted.mean(ret_excess, mktcap))
strategy_portfolio = momentum_portfolios %>%
group_by(month) %>%
mutate(breakpoint = median(momentum),
portfolio = case_when(momentum <= breakpoint ~ "low",
momentum > breakpoint ~ "high")) %>%
group_by(month,portfolio) %>%
summarise(excess = weighted.mean(ret_excess, mktcap)) # Value weighted return by high or low grouped momentum values.
strategy_portfolio
strategy_portfolio = momentum_portfolios %>%
group_by(month) %>%
mutate(breakpoint = median(momentum),
portfolio = case_when(momentum <= breakpoint ~ "low",
momentum > breakpoint ~ "high")) %>%
group_by(month,portfolio) %>%
summarise(excess_ret = weighted.mean(ret_excess, mktcap)) # Value weighted return by high or low grouped momentum values.
strategy_portfolio %>%
pivot_wider(names_from = portfolio, values_from = excess_ret) %>%
mutate(high_low = high - low)
strategy_portfolio
strategy_portfolio %>%
pivot_wider(names_from = portfolio, values_from = excess_ret) %>%
mutate(high_low = high - low) %>%
left_join(factors_ff_monthly, by = "month")
strategy_portfolio %>%
pivot_wider(names_from = portfolio, values_from = excess_ret) %>%
mutate(high_low = high - low) %>%
left_join(factors_ff_monthly, by = "month") %>%
lm(high_low ~ mkt_excess, data = .)
mom_portfolios_summary
strategy_portfolio %>%
pivot_wider(names_from = portfolio, values_from = excess_ret) %>%
mutate(high_low = high - low) %>%
left_join(factors_ff_monthly, by = "month") %>%
lm(high_low ~ mkt_excess, data = .) %>% broom::tidy() %>% kableExtra::kable()
strategy_portfolio %>%
pivot_wider(names_from = portfolio, values_from = excess_ret) %>%
mutate(high_low = high - low) %>%
left_join(factors_ff_monthly, by = "month") %>%
lm(high_low ~ mkt_excess, data = .) %>% broom::tidy()
strategy_portfolio %>%
pivot_wider(names_from = portfolio, values_from = excess_ret) %>%
mutate(high_low = high - low) %>%
left_join(factors_ff_monthly, by = "month") %>%
lm(high_low ~ mkt_excess, data = .)
strategy_portfolio %>%
pivot_wider(names_from = portfolio, values_from = excess_ret) %>%
mutate(high_low = high - low) %>%
left_join(factors_ff_monthly, by = "month") %>%
lm(high_low ~ mkt_excess, data = .) %>% broom::tidy()
strategy_portfolio %>%
pivot_wider(names_from = portfolio, values_from = excess_ret) %>%
mutate(high_low = high - low) %>%
left_join(factors_ff_monthly, by = "month") %>%
lm(high_low ~ mkt_excess, data = .) %>% broom::tidy() %>% kableExtra::kable()
strategy_portfolio %>%
pivot_wider(names_from = portfolio, values_from = excess_ret) %>%
mutate(high_low = high - low) %>%
left_join(factors_ff_monthly, by = "month") %>%
lm(high_low ~ mkt_excess, data = .) %>% broom::tidy() %>% round(digits=2)
strategy_portfolio %>%
pivot_wider(names_from = portfolio, values_from = excess_ret) %>%
mutate(high_low = high - low) %>%
left_join(factors_ff_monthly, by = "month") %>%
lm(high_low ~ mkt_excess, data = .) %>%
strategy_portfolio %>%
pivot_wider(names_from = portfolio, values_from = excess_ret) %>%
mutate(high_low = high - low) %>%
left_join(factors_ff_monthly, by = "month") %>%
lm(high_low ~ mkt_excess, data = .)
strategy_portfolio %>%
pivot_wider(names_from = portfolio, values_from = excess_ret) %>%
mutate(high_low = high - low) %>%
left_join(factors_ff_monthly, by = "month") %>%
lm(high_low ~ mkt_excess, data = .)
strategy_portfolio %>%
pivot_wider(names_from = portfolio, values_from = excess_ret) %>%
mutate(high_low = high - low) %>%
left_join(factors_ff_monthly, by = "month") %>%
lm(high_low ~ mkt_excess, data = .) %>% broom::tidy()
?tidy
strategy_portfolio %>%
pivot_wider(names_from = portfolio, values_from = excess_ret) %>%
mutate(high_low = high - low) %>%
left_join(factors_ff_monthly, by = "month") %>%
lm(high_low ~ mkt_excess, data = .) %>% broom::tidy()
mom_stat = data_for_sorting %>%
group_by(month) %>%
summarise(across(
momentum,
list(Mean = mean,SD = sd, min = min,
q5 = ~quantile(., 0.05),
q25 = ~quantile(., 0.25),
median = median,
q75 = ~quantile(., 0.75),
q95 = ~quantile(., 0.95),
max = max
),
.names = "{.fn}"))
mom_stat
mom_stat %>%
summarise(across(-month,mean))
data_for_sorting %>%
mutate(log_mktcap = log(mktcap)) %>%
select(momentum,log_mktcap) %>%
cor()
# Loading packages:
library(RSQLite)
library(dbplyr)
library(dplyr)
library(tidyverse)
library(lubridate)
library(sandwich)
library(lmtest)
library(scales)
library(slider)
library(furrr)
#setwd('C:/Users/Marti/OneDrive - University of Copenhagen/KU/2. semester/Advanced Empirical Finance/AEF')
# ******************************************
# 4.1 Data preparation
# ******************************************
tidy_finance <- dbConnect(SQLite(), "data/tidy_finance.sqlite",
extended_types = TRUE
)
crsp_monthly <- tbl(tidy_finance, "crsp_monthly") %>%
collect() %>%
mutate(month = as.Date(as.POSIXct.Date(month)))
factors_ff_monthly <- tbl(tidy_finance, "factors_ff_monthly") %>%
collect() %>%
mutate(month = as.Date(as.POSIXct.Date(month)))
crsp_monthly <- crsp_monthly %>%
left_join(factors_ff_monthly, by = "month") %>%
select(permno, month, ret_excess, mkt_excess, mktcap,mktcap_lag)
dbListTables(tidy_finance) # check the database
ret = crsp_monthly %>%
group_by(month) %>%
summarise(across(
ret_excess,
list(daily_mean = mean,
daily_sd = sd,
daily_min = min,
daily_max = max
)
)) %>% summarise(across(-month,mean)) %>%
rename(mean=ret_excess_daily_mean, sd=ret_excess_daily_sd, min=ret_excess_daily_min, max=ret_excess_daily_max) %>%
pivot_longer(
everything()
) %>%
rename(ret_excess=value) %>%
mutate(ret_excess = format(ret_excess, scientific = F, digits=2))
mkt = crsp_monthly %>%
group_by(month) %>%
summarise(across(
mktcap,
list(daily_mean = mean,
daily_sd = sd,
daily_min = min,
daily_max = max
)
)) %>% summarise(across(-month,mean)) %>%
rename(mean=mktcap_daily_mean, sd=mktcap_daily_sd, min=mktcap_daily_min, max=mktcap_daily_max) %>%
pivot_longer(
everything()
)  %>%
rename(mktcap=value,n=name) %>%
mutate(mktcap = format(mktcap, scientific = F, digits=2))
ret %>%
cbind(mkt) %>%
select(-n)
crsp_monthly %>% group_by(permno) %>%
mutate(ret_excess_lag = lag(ret_excess))
crsp_monthly %>%
group_by(permno)%>%
mutate(month = month %m+% months(1))
mktcap_lag_12 <- crsp_monthly %>%
mutate(month = month %m+% months(12)) %>%
select(permno, month, mktcap_lag_12 = mktcap) %>%
drop_na()
data_for_sorting <- crsp_monthly %>%
left_join(mktcap_lag_12, c("permno","month")) %>%
drop_na()
data_for_sorting <-  data_for_sorting %>%
mutate(momentum =  100*(mktcap_lag-mktcap_lag_12)/mktcap_lag_12)
mom_stat = data_for_sorting %>%
group_by(month) %>%
summarise(across(
momentum,
list(Mean = mean,SD = sd, min = min,
q5 = ~quantile(., 0.05),
q25 = ~quantile(., 0.25),
median = median,
q75 = ~quantile(., 0.75),
q95 = ~quantile(., 0.95),
max = max
),
.names = "{.fn}"))
mom_stat %>%
summarise(across(-month,mean))
data_for_sorting %>%
mutate(log_mktcap = log(mktcap)) %>%
select(momentum,log_mktcap) %>%
cor()
