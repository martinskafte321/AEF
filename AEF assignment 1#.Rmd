---
title: "AEF assignment 1#"
author: "Martin, Fred and Oliver"
date: "6/3/2022"
output: html_document
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r echo=FALSE, warning=FALSE}
# Loading packages:
library(RSQLite)
library(dbplyr)
library(dplyr)
library(tidyverse)
library(lubridate)
library(sandwich)
library(lmtest)
library(scales)
library(slider)
library(furrr)
library(acnr)
library(R.utils)



#setwd('C:/Users/Marti/OneDrive - University of Copenhagen/KU/2. semester/Advanced Empirical Finance/AEF')
```

### 1. Read in the monthly CRSP date (crsp_monthly) and the monthly market excess returns (factors_ff_monthly) from the tidy_finance.sqlite database. Very briefly state the definition of the variables permno, ret_excess and mktcap. Provide suitable summary statistics of the cross-section of monthly excess returns and market capitalization in the CRSP sample.




```{r}
# ******************************************
# 4.1 Data preparation
# ******************************************

tidy_finance <- dbConnect(SQLite(), "data/tidy_finance.sqlite",
                          extended_types = FALSE
      )

crsp_monthly <- tbl(tidy_finance, "crsp_monthly") %>%
  collect() %>%
  mutate(month = as.Date(as.POSIXct.Date(month)))

factors_ff_monthly <- tbl(tidy_finance, "factors_ff_monthly") %>%
  collect() %>%
  mutate(month = as.Date(as.POSIXct.Date(month)))

crsp_monthly <- crsp_monthly %>%
  left_join(factors_ff_monthly, by = "month") %>%
  select(permno, month, ret_excess, mkt_excess, mktcap,mktcap_lag)


dbListTables(tidy_finance) # check the database
```
*Very briefly state the definition of the variables permno, ret_excess and mktcap*. 
Definition of PERMNO, as per {PERMNO}: "PERMNO is a unique permanent security identification number assigned by CRSP to each security". Thus PERMNO is a unique company identifier. 

Definition of excess returns, as per {exret}: Excess return for a stock is the difference between the stock return and the return on the risk-free security over the same period. For such risk-free securities, it is common to use a government bond such as a 10-year US Treasury bond.\\ 

Definition of mktcap, as per {mktcap}: The variable 'mktcap' is defined as the market capitalization, which refers to the total dollar market value of a company's outstanding shares of stock. Market capitalization is commonly referred to as "market cap," and is calculated by multiplying the total number of a company's outstanding shares by the current market price of one share.

*Provide suitable summary statistics of the cross-section of monthly excess returns and market capitalization in the CRSP sample*
```{r}
ret = crsp_monthly %>% 
  group_by(month) %>%
  summarise(across(
    ret_excess,
    list(daily_mean = mean,
         daily_sd = sd,
         daily_min = min,
         daily_max = max
         ) 
  )) %>% summarise(across(-month,mean)) %>%
  rename(mean=ret_excess_daily_mean, sd=ret_excess_daily_sd, min=ret_excess_daily_min, max=ret_excess_daily_max) %>%
  pivot_longer(
    everything()
  ) %>% 
  rename(ret_excess=value) %>%
  mutate(ret_excess = format(ret_excess, scientific = F, digits=2))


mkt = crsp_monthly %>% 
  group_by(month) %>%
  summarise(across(
    mktcap,
    list(daily_mean = mean,
         daily_sd = sd,
         daily_min = min,
         daily_max = max
         ) 
  )) %>% summarise(across(-month,mean)) %>%
  rename(mean=mktcap_daily_mean, sd=mktcap_daily_sd, min=mktcap_daily_min, max=mktcap_daily_max) %>%
   pivot_longer(
    everything()
  )  %>% 
  rename(mktcap=value,n=name) %>%
  mutate(mktcap = format(mktcap, scientific = F, digits=2))

ret %>% 
  cbind(mkt) %>%
  select(-n)
```
Summary statistics for ret_excess and mktcap shows that the mean return per month is 0.79% although the median is -0.0004%. An important distinction between the variables is that ret_excess is in relative numbers, while mktcap of course is absolute, since the return is a relative change and market cap is a true number. 

### 2. Generate ret_excess_lag. State why the provided code does not provide the correct result if crsp_monthly contains missing values. Report summary statistics and/or visualizations showing whether r_t and r_t-1 exhibit significant autocorrelation. 

# Briefly stating why provided code gives incorrect results
If there are implicitly missing values in the dataset, that values for some months are not included, the lagged value ret_excess_lag will not necessarily contain the excess return of the previous month, but rather the excess return of the previous month included in the dataset. 

# Generate ret_excess_lag.
```{r}
ret_excess_lag <- crsp_monthly %>%
  mutate(month = month %m+% months(1)) %>%
  select(permno, month, ret_excess_lag = ret_excess)
  
crsp_monthly <- crsp_monthly %>%
  left_join(ret_excess_lag, by = c("permno", "month"))
```


```{r}
crsp_monthly %>% group_by(permno) %>%
mutate(ret_excess_lag = lag(ret_excess))
```

The second code, given in the assignment, returns a variable with one explicitly missing value for each permno. This is the first value for each permno. The first code avoids missing values, as one month is added to each observation and therefore the first value 

# Autocorrelation from r_t-1 to r_t?
Visualizing ret_excess. 
```{r}
crsp_monthly %>%
  ggplot(aes(x = month, y = ret_excess)) +
  geom_line() +
  labs(
    x = NULL,
    y = NULL,
    title = "Excess returns", 
    subtitle = "Monthly market excess returns"
  )
```

```{r}
crsp_monthly %>%
drop_na() %>%
  select(ret_excess)%>%
pacf()
```

The mean of excess returns does not seem to fluctuate around a constant value. There seems to be clusters of higher and lower excess returns, which can be seen as evidence for a short-term momentum effect. However, exact autocorrelations are more visible in the PACF-plot. There, we can see that for most lags, significant autocorrelation exists. 

### 3. Generate a new column mktcap_lag_12 which contains the firms’ market capitalization 12-month prior to the measurement date.

Lagging a variable can be a frustrating task, since the days of months differ. The below function will always return a date in the nth month after Date. This allows for 1) not exceeding the end of month and 2) handles NA's really well. 

First we create a variable by lagging the month column without touching the others. Next, we merge our sorting variable with the return data. We use the 12-month lagged marketcap as a sorting variable to ensure that the sorts rely only on information available when we create the portfolios.
```{r}
mktcap_lag_12 <- crsp_monthly %>%
  mutate(month = month %m+% months(12)) %>%
  select(permno, month, mktcap_lag_12 = mktcap) %>%
  drop_na()

 data_for <- crsp_monthly %>%
  left_join(mktcap_lag_12, c("permno","month")) %>%
   drop_na()
```

### Compute the momentum of stock i as the relative change in market capitalization, represented in percentage terms (1.00 is a 1% return) during the period covering months t−12 until t−1. Specifically, if $mc_{i,t}$ denotes the market capitalization of stock i in month t, compute momentum as  
$$Mom_{i,t} = 100\frac{(mc_{i,t-1} −mc_{i,t-12})}{mc_{i,t-12}}$$
```{r}
data_for <-  data_for %>%
  mutate(momentum =  100*(mktcap_lag-mktcap_lag_12)/mktcap_lag_12)
```
### Briefly discuss the difference between computing momentum as the relative change in prices or as the relative change in market capitalization.*
Since market cap is basically the stock price times volume, there is rarely a large distinction between the two. But the change in market cap will always reflect a change in the public value of a company whereas a change in stock price might be due to stock split or buybacks, which would have significant implications for the stock price but not the actual market capitalization. 

### Create summary statistics for $Mom_{i,t}$  as follows: Each month, compute the mean, standard deviation, minimum, fifth percentile, 25th percentile, median, 75th percentile, 95th percentile, and maximum values of the cross-sectional distribution of $Mom_{i,t}$. 

```{r}
mom_stat = data_for %>% 
  group_by(month) %>%
  summarise(across(
    momentum,
    list(Mean = mean,SD = sd, min = min,
         q25 = ~quantile(., 0.25),
         median = median,
         q75 = ~quantile(., 0.75),
         max = max
         ),
    .names = "{.fn}"))

```

### Then, report the time-series means for each cross-sectional value. What is the mean value of $Mom_{i,t}$ in the average month? What is the cross-sectional standard deviation? Does momentum exhibit a positive correlation with $log(mc_{i,t}$?*

```{r}
mom_stat %>% 
  summarise(across(-month,mean)) 

data_for %>%
  mutate(log_mktcap = log(mktcap)) %>%
  select(momentum,log_mktcap) %>%
  cor()
  
```
Yes, there is a positive correlation coefficient of 0.067 between the momentum value and log of market capitalization. 

### 6. Based on answers in 1 and 3, why can a momentum stategy be costlier to trade than other strategies? 

The costs likely comes from making changes in the momentum strategy portfolio, i.e buying and selling stocks, on a more frequent basis than for other portfolios. Why?



# Alternative stategy that effectively captures the momentum premium and deliveres lower trading costs. Report sharpe-ratio and average turnover. 


