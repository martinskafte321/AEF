---
title: "AEF assignment 1#"
author: "Martin, Fred and Oliver"
date: "6/3/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r echo=false}
### Loading packages:
library(RSQLite)
library(dbplyr)
library(dplyr)
library(tidyverse)
library(lubridate)
library(sandwich)
library(lmtest)
library(scales)
library(slider)
library(furrr)

#setwd('C:/Users/Marti/OneDrive - University of Copenhagen/KU/2. semester/Advanced Empirical Finance/AEF')
```

### 1. Read in the monthly CRSP date (crsp_monthly) and the monthly market excess returns (factors_ff_monthly) from the tidy_finance.sqlite database. Very briefly state the definition of the variables permno, ret_excess and mktcap. Provide suitable summary statistics of the cross-section of monthly excess returns and market capitalization in the CRSP sample.




```{r}
# ******************************************
# 4.1 Data preparation
# ******************************************

tidy_finance <- dbConnect(SQLite(), "data/tidy_finance.sqlite",
                          extended_types = TRUE)

crsp_monthly <- tbl(tidy_finance, "crsp_monthly") %>%
  collect() %>%
  mutate(month = as.Date(as.POSIXct.Date(month)))

factors_ff_monthly <- tbl(tidy_finance, "factors_ff_monthly") %>%
  collect() %>%
  mutate(month = as.Date(as.POSIXct.Date(month)))

crsp_monthly <- crsp_monthly %>%
  left_join(factors_ff_monthly, by = "month") %>%
  select(permno, month, ret_excess, mkt_excess, mktcap)


dbListTables(tidy_finance) # check the database
```
*Very briefly state the definition of the variables permno, ret_excess and mktcap*. 
Definition of PERMNO, as per {PERMNO}: "PERMNO is a unique permanent security identification number assigned by CRSP to each security". Thus PERMNO is a unique company identifier. 

Definition of excess returns, as per {exret}: Excess return for a stock is the difference between the stock return and the return on the risk-free security over the same period. For such risk-free securities, it is common to use a government bond such as a 10-year US Treasury bond.\\ 

Definition of mktcap, as per {mktcap}: The variable 'mktcap' is defined as the market capitalization, which refers to the total dollar market value of a company's outstanding shares of stock. Market capitalization is commonly referred to as "market cap," and is calculated by multiplying the total number of a company's outstanding shares by the current market price of one share.

*Provide suitable summary statistics of the cross-section of monthly excess returns and market capitalization in the CRSP sample*
```{r}
crsp_monthly %>% 
    select(ret_excess, mktcap) %>% 
    map_df(.f = ~ broom::tidy(summary(.x,digits = 2)), .id = "variable") %>%
  mutate(mean = format(mean, scientific = F)) %>%
  select(variable, minimum, maximum, median, mean)
```
Summary statistics for ret_excess and mktcap shows that the mean return per month is 0.79% although the median is -0.0004%. An important distinction between the variables is that ret_excess is in relative numbers, while mktcap of course is absolute, since the return is a relative change and market cap is a true number. 



