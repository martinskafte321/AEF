---
title: "AEF assignment 1#"
author: "Martin, Fred and Oliver"
date: "6/3/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r echo=FALSE}
# Loading packages:
library(RSQLite)
library(dbplyr)
library(dplyr)
library(tidyverse)
library(lubridate)
library(sandwich)
library(lmtest)
library(scales)
library(slider)
library(furrr)

#setwd('C:/Users/Marti/OneDrive - University of Copenhagen/KU/2. semester/Advanced Empirical Finance/AEF')
```

### 1. Read in the monthly CRSP date (crsp_monthly) and the monthly market excess returns (factors_ff_monthly) from the tidy_finance.sqlite database. Very briefly state the definition of the variables permno, ret_excess and mktcap. Provide suitable summary statistics of the cross-section of monthly excess returns and market capitalization in the CRSP sample.




```{r}
# ******************************************
# 4.1 Data preparation
# ******************************************

tidy_finance <- dbConnect(SQLite(), "data/tidy_finance.sqlite",
                          extended_types = TRUE)

crsp_monthly <- tbl(tidy_finance, "crsp_monthly") %>%
  collect() %>%
  mutate(month = as.Date(as.POSIXct.Date(month)))

factors_ff_monthly <- tbl(tidy_finance, "factors_ff_monthly") %>%
  collect() %>%
  mutate(month = as.Date(as.POSIXct.Date(month)))

crsp_monthly <- crsp_monthly %>%
  left_join(factors_ff_monthly, by = "month") %>%
  select(permno, month, ret_excess, mkt_excess, mktcap)


dbListTables(tidy_finance) # check the database
```
*Very briefly state the definition of the variables permno, ret_excess and mktcap*. 
Definition of PERMNO, as per {PERMNO}: "PERMNO is a unique permanent security identification number assigned by CRSP to each security". Thus PERMNO is a unique company identifier. 

Definition of excess returns, as per {exret}: Excess return for a stock is the difference between the stock return and the return on the risk-free security over the same period. For such risk-free securities, it is common to use a government bond such as a 10-year US Treasury bond.\\ 

Definition of mktcap, as per {mktcap}: The variable 'mktcap' is defined as the market capitalization, which refers to the total dollar market value of a company's outstanding shares of stock. Market capitalization is commonly referred to as "market cap," and is calculated by multiplying the total number of a company's outstanding shares by the current market price of one share.

*Provide suitable summary statistics of the cross-section of monthly excess returns and market capitalization in the CRSP sample*
```{r}
crsp_monthly %>% 
    select(ret_excess, mktcap) %>% 
    map_df(.f = ~ broom::tidy(summary(.x,digits = 2)), .id = "variable") %>%
  mutate(mean = format(mean, scientific = F)) %>%
  select(variable, minimum, maximum, median, mean)

ret = crsp_monthly %>% 
  group_by(month) %>%
  summarise(across(
    ret_excess,
    list(daily_mean = mean,
         daily_sd = sd,
         daily_min = min,
         daily_max = max
         ) 
  )) %>% summarise(across(-month,mean)) %>%
  rename(mean=ret_excess_daily_mean, sd=ret_excess_daily_sd, min=ret_excess_daily_min, max=ret_excess_daily_max) %>%
  pivot_longer(
    everything()
  ) %>% 
  rename(ret_excess=value)


mkt = crsp_monthly %>% 
  group_by(month) %>%
  summarise(across(
    mktcap,
    list(daily_mean = mean,
         daily_sd = sd,
         daily_min = min,
         daily_max = max
         ) 
  )) %>% summarise(across(-month,mean)) %>%
  rename(mean=mktcap_daily_mean, sd=mktcap_daily_sd, min=mktcap_daily_min, max=mktcap_daily_max) %>%
   pivot_longer(
    everything()
  )  %>% 
  rename(mktcap=value,n=name) %>%
  mutate(mktcap = format(mktcap, scientific = F))

ret %>% 
  cbind(mkt) %>%
  select(-n)
```
Summary statistics for ret_excess and mktcap shows that the mean return per month is 0.79% although the median is -0.0004%. An important distinction between the variables is that ret_excess is in relative numbers, while mktcap of course is absolute, since the return is a relative change and market cap is a true number. 


### 3. Generate a new column mktcap_lag_12 which contains the firms’ market capitalization 12-month prior to the measurement date.
Compute the momentum of stock i as the relative change in market
capitalization, represented in percentage terms (1.00 is a 1% return) during the period covering months
t −12 until t −1. Specifically, if mci,t denotes the market capitalization of stock i in month t, compute
momentum as
$$Mom_{i,t} = 100\frac{(mc_{i,t-1} −mc_{i,t-12})}{mc_{i,t-12}}$$
*Note that crsp_monthly already contains a column mktcap_lag with mci,t−1. Briefly discuss the
difference between computing momentum as the relative change in prices or as the relative change in
market capitalization.*

Create summary statistics for M omi,t as follows: Each month, compute the mean, standard deviation,
minimum, fifth percentile, 25th percentile, median, 75th percentile, 95th percentile, and maximum values
of the cross-sectional distribution of M omi,t. Then, report the time-series means for each cross-sectional
value. What is the mean value of M omi,t in the average month? What is the cross-sectional standard
deviation? Does momentum exhibit a positive correlation with log(mci,t)?

```{r}

```


