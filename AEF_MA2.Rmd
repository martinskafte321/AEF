---
title: "Assignment 2"
author: "Martin, Oliver and Fred"
date: "4/6/2022"
output:
  pdf_document: default
  html_document: default
---

```{r, message=FALSE}
library(RSQLite)
library(tidyverse)
library(tidymodels) 
library(furrr) 
library(glmnet)
library(broom)
library(timetk)
library(scales)
library(lubridate)
library(scales)
library(frenchdata)
library(caret)
library(ggplot2)
library(ggpubr)
library(kableExtra)
library(mltools)
library(data.table)
library(vtable)
```


```{r}
#tidy_finance_ML <- dbConnect(SQLite(), "/Users/fredlundahl/Desktop/AEF/data/tidy_finance_ML.sqlite", extended_types = TRUE)

tidy_finance_ML <- dbConnect(SQLite(), "/Users/olivernystrom/Desktop/Coding/AEF/Data/tidy_finance_ML.sqlite", 
                          extended_types = TRUE)

# Connecting to SQLite, reading in stock_charachteristics_monthly.
#tidy_finance_ML <- dbConnect(SQLite(), "data/tidy_finance_ML.sqlite", extended_types = TRUE)

characteristics <- tbl(tidy_finance_ML, "stock_characteristics_monthly") %>%
  collect() %>%
  mutate(month = as.Date(as.POSIXct.Date(month)))
```


We have chosen to work with five firm characteristics (beta, turn, mom1m, mom12m and mom36m) and four macro indicators (dp, ep, bm and ntis). Beta is the market beta, which indicates the movement of the individual stock relative to the market. Turn is the turnover of a stock and is a measure of liquidity. Mom1m is the one month momentum, which is included to capture short-term reversal. Mom12m (12 month momentum) is brought as the general momentum measure and mom36m as a long-term reversal indicator. 

Bringing three momentum variables into the model might be a stretch, but these are shown (from variable importance in Gu, Kelly and Xiu (2019)) to be quite significant predictors in asset pricing.  

Bm is the book-to-market ratio, which measures the total book value (that is company value from earnings statement) relative to the market value (on the stock market), ntis is the Net Eqiuty Expansion, which measures the ratio of 12-month moving sums of net issues on the NYSE divided by the total end-of-year market cap of NYSE stocks. EP is the earnings-to-price ratio, which is the difference between the log of earnings and the log of prices. DP is the Dividend-Price ration, which is the difference between log of dividends and log of prices. 
```{r}
# Remove all observations prior to January 1st, 2005 by filtering out earlier dates. 
data <- characteristics %>%
  filter(month >= "2005-01-01") %>%
  # selecting 5 characteristics and 4 macro variables
  select(month, permno, sic2, ret_excess, mktcap_lag, characteristic_beta, characteristic_turn,   characteristic_mom1m, characteristic_mom12m, characteristic_mom36m, macro_dp, macro_ep, macro_bm, macro_ntis) %>%
  drop_na()

remove(characteristics)
```
## Here, discussion on selection of variables. 

```{r}
data %>%
  select(-month, -sic2, -permno, -mktcap_lag) %>%
  sumtable(
    summ = c('mean(x)','sd(x)','min(x)','pctile(x)[25]','pctile(x)[75]','max(x)'),
    summ.names = c('Mean','Sd.','Min','Pctl. 25','Pctl. 75','Max'),
     labels = c('Return excess','Market beta',
                       'Turnover','Momentum (1)','Momentum (12)','Momentum (36)', 'Dividend-Price','Earnings-price','Book-Market', 'Net Eqiuty Expansion'),
    digits = 2,
    out = "return") %>%
  kbl(caption = "Summary table of variables") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```


# Stats number of firms
The bar plot lists all industries on the x-axis and shows the number of firms for each industry. The figure shows a clear gap in the frequency for some industries with industry 73 (Business Services), 28 (Chemical & Allied Products), 60 (Depository Institutions), 36 (Electronic & Other Electric Equipment) and 38 (Instruments & Related Products) most frequently represented.
Source: https://mckimmoncenter.ncsu.edu/2digitsiccodes-2/
```{r} 
data %>% 
  select(permno, sic2) %>%
  distinct() %>%
  group_by(sic2) %>%
  summarise(permno_n = n()) %>%
  mutate(sic2 = factor(sic2)) %>%
  ggplot(aes(
  x = sic2, y = permno_n),
  level = sic2) +
  geom_bar(stat="identity", width=.5, fill="tomato3") +
  labs(title="Barplot of number of firms per industry",
         x="Industry class",
         y="Number of firms")
  
```


# Illustartions of macroeconomic predictors
```{r,echo=FALSE}

  
 plot_ntis_bm = data %>% 
  select(month, macro_ntis, macro_bm) %>%
  rename('Book-to-Market' = macro_bm,'Net Eqiuty Expansion' = macro_ntis) %>%
  melt(id='month') %>%
  ggplot(aes(x=month,y=value,colour=variable, group=variable)) + 
  scale_color_manual(values = c("#CC79A7", "#009E73")) +
  geom_line() +
  labs(
    title = "Macro indicator time series",
    x = "Date",
    y = "Indicator value")  +
  theme(legend.position="top",
        legend.title = element_blank())
  
  plot_ep_dp = data %>% 
  select(month,macro_ep, macro_dp) %>%
    rename('Earnings-Price' = macro_ep,'Dividend-Price' = macro_dp) %>%
  melt(id='month') %>%
  ggplot(aes(x=month,y=value,colour=variable, group=variable)) + 
  scale_color_manual(values = c("#E69F00", "#293352")) +
  geom_line() +
  labs(
    x = "Date",
    y = "Indicator value")  +
  theme(legend.position="top",
        legend.title = element_blank())
  
  
# We can arrange the two plots to show them together in one graph. 
ggarrange(plot_ntis_bm, plot_ep_dp,
                    ncol = 1, nrow = 2)

remove(plot_ntis_bm,plot_ep_dp)
```

First, we want to make sure that no data used to train the models are utilized in testing the model, since this would indicate a look-ahead-bias. 

```{r}
split <- initial_time_split(
  data,
  prop = 4/5
)
```


Second, we create a recipe from tidymodels to perform two cleaning steps: 1) to locate all interacting terms between the macro indicators and company characteristics, and 2) to modify the industry specific value into a dummy variable, since this format is more friendly to machine learning. 

```{r}
# We need sic2 to be a factor and not just a categorical variable, since this allow us to interpret the levels (values) as 0's and 1's. 
data = data %>%
  mutate(sic2 = as.factor(sic2))


# This function takes the data from our dataset (sic2) and transforms the categorical variable into 70 columns of ones or zeros depending on the actual value of the industry indicator. 

step_onehot <- function(x){one_hot(as.data.table(x))}


recipe = recipe(ret_excess ~ ., data = training(split)) %>%
  step_rm(month, mktcap_lag) %>%
  step_interact(terms = ~ contains("characteristic"):contains("macro")) %>%
  step_mutate_at(sic2, fn = step_onehot)

prep_data <- prep(recipe, data)
#baked_data <- bake(prep(recipe, training(split)), new_data = testing(split))
prep_data
```

After specifying the recipe-steps that should transform the data into something more machine learning-friendly, we can estimate a model. 

```{r}
# Det her er bare en test-model og ikke den vi rigtigt skal lave. 
lm_model <- linear_reg(
  penalty = 0.0001,
  mixture = 1
) %>% set_engine("glmnet", intercept = FALSE)
```




